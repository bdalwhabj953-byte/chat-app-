<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title> Ù…Ø¬ØªÙ…Ø¹ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</title>
<style>
  :root{
    --bg:#111;
    --panel:#222;
    --accent:#25D366;
    --muted:#ccc;
  }
  html,body{height:100%;margin:0;font-family:"Tahoma",sans-serif;background:var(--bg);color:#fff;font-size:14px; -webkit-font-smoothing:antialiased;}
  header{
    background:#075E54;padding:10px;display:flex;align-items:center;justify-content:center;gap:10px;position:sticky;top:0;z-index:20;
  }
  header button{background:var(--accent);color:#000;border:none;padding:6px 8px;border-radius:8px;cursor:pointer;font-size:13px;}
  #messages{
    height:calc(100vh - 260px);
    overflow-y:auto;
    padding:10px;
    background:#000;
    font-size:14px;
    display:flex;flex-direction:column;gap:6px;
    transform-origin: center top;
    -webkit-overflow-scrolling:touch;
  }
  .message{
    margin:0;
    padding:10px 12px;
    border-radius:12px;
    max-width:80%;
    word-wrap:break-word;
    position:relative;
    box-shadow:0 1px 0 rgba(255,255,255,0.02);
    line-height:1.35;
  }
  /* Ø§Ù„Ù…Ø±Ø³Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± */
  .sent{background:var(--accent);color:#000;margin-right:auto;text-align:left;}
  /* Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø© Ù…Ù† Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†: Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† */
  .received{background:#333;color:#fff;margin-left:auto;text-align:right;}
  .meta{font-size:12px;color:var(--muted);margin-bottom:6px;display:block;}
  .deletedMsg{font-style:italic;color:#999;padding:8px;}
  #inputArea{display:flex;padding:8px;gap:8px;background:var(--panel);align-items:center;position:sticky;bottom:0;}
  #fileInput{display:none;}
  button.iconBtn{background:#128C7E;border:none;color:white;font-size:18px;padding:8px;border-radius:50%;cursor:pointer;}
  #sendBtn{background:var(--accent);border:none;color:#000;font-size:16px;padding:8px 12px;border-radius:50%;cursor:pointer;}
  #messageInput{flex:1;padding:10px;border-radius:20px;border:none;font-size:14px;background:#151515;color:#fff;}
  #loginBox{background:#1e1e1e;padding:16px;text-align:center;}
  #loginBox input,#loginBox select{padding:10px;margin:6px;border-radius:10px;border:none;width:86%;font-size:14px;background:#111;color:#fff;}
  #loginBtn{padding:8px 16px;background:var(--accent);border:none;border-radius:10px;cursor:pointer;font-size:14px;}
  #participantsBtn{position:absolute;top:12px;left:12px;background:var(--accent);color:#000;border:none;padding:6px 8px;border-radius:8px;cursor:pointer;font-size:12px;}
  #participantsPanel{display:none;position:fixed;top:60px;left:50%;transform:translateX(-50%);width:92%;max-width:340px;background:var(--panel);padding:10px;border-radius:12px;max-height:60vh;overflow:auto;z-index:100;}
  #participantsPanel h3{margin:0 0 8px 0;text-align:center;}
  #participantsList{list-style:none;padding:0;margin:0;}
  #participantsList li{padding:6px;border-bottom:1px solid #333;display:flex;justify-content:space-between;align-items:center;}
  #emojiPanel{display:none;position:absolute;background:var(--panel);padding:8px;border-radius:8px;border:1px solid #333;z-index:50;}
  #emojiPanel span{cursor:pointer;font-size:18px;padding:4px;display:inline-block;}
  #notificationSettings{display:flex;gap:10px;justify-content:center;margin:8px;}
  #downloadChat{background:#3498db;border:none;color:white;padding:6px 10px;border-radius:8px;cursor:pointer;}
  .typingIndicator{font-size:12px;color:var(--muted);padding:6px;}
  /* Action menu */
  .actionMenu{position:fixed;background:var(--panel);border:1px solid #333;padding:6px;border-radius:8px;z-index:9999;direction:rtl;}
  .actionMenu button{display:block;width:100%;background:transparent;border:none;color:#fff;padding:6px;text-align:right;cursor:pointer;border-radius:6px;}
  .actionMenu button:hover{background:#2a2a2a;}
  /* responsive */
  @media (max-width:420px){
    #messages{height:calc(100vh - 300px);}
  }
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:8px;">
    ğŸ’¬ <strong>Ù…Ø¬ØªÙ…Ø¹ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</strong>
  </div>
  <button id="participantsBtn">ğŸ‘¥ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</button>
 </header>

<div id="loginBox">
  <h3>ğŸ”‘ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ</h3>
  <input type="text" id="usernameInput" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ" />
  <select id="roleInput">
    <option>Ù…Ø¹Ù„Ù…</option>
    <option>Ø·Ø§Ù„Ø¨</option>
    <option>ÙˆÙ„ÙŠ Ø£Ù…Ø±</option>
  </select>
  <br />
  <button id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
</div>

<div id="messages" style="display:none;"></div>

<div id="inputArea" style="display:none;">
  <div style="position:relative;">
    <button id="emojiBtn" class="iconBtn">ğŸ˜Š</button>
    <div id="emojiPanel">
      <span>ğŸ˜€</span> <span>ğŸ˜ƒ</span> <span>ğŸ˜„</span> <span>ğŸ˜</span> <span>ğŸ˜†</span> <span>ğŸ˜‚</span> <span>ğŸ™‚</span> <span>ğŸ™ƒ</span> <span>ğŸ˜‰</span> <span>ğŸ˜Š</span> <span>ğŸ˜‡</span>
    </div>
  </div>

  <input type="file" id="fileInput" accept="image/*,video/*,application/*" />
  <button id="fileBtn" class="iconBtn">ğŸ“</button>
  <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." autocomplete="off" />
  <button id="sendBtn">â¤</button>
</div>

<div id="notificationSettings">
  <label style="font-size:13px;"><input type="checkbox" id="notifyAll" checked /> Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¬Ù…ÙŠØ¹</label>
  <label style="font-size:13px;"><input type="checkbox" id="notifyTeachers" /> Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…/Ø§Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·</label>
</div>

<div id="participantsPanel">
  <h3>ğŸ‘¥ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</h3>
  <ul id="participantsList"></ul>
  <div style="text-align:center;margin-top:8px;"><button onclick="document.getElementById('participantsPanel').style.display='none'">Ø¥ØºÙ„Ø§Ù‚</button></div>
</div>

<script type="module">
/* Firebase imports */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, onValue, set, update, get } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

/* === Ø¥Ø¹Ø¯Ø§Ø¯ Firebase (Ø§Ø­ØªÙØ¸Øª Ø¨Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªÙƒ) === */
const firebaseConfig = {
  apiKey: "AIzaSyCe-UJdZAchrvED18Z_ZA0j6sL_RUga1Vg",
  authDomain: "chat-app-ff837.firebaseapp.com",
  databaseURL: "https://chat-app-ff837-default-rtdb.firebaseio.com",
  projectId: "chat-app-ff837",
  storageBucket: "chat-app-ff837.firebasestorage.app",
  messagingSenderId: "328877248171",
  appId: "1:328877248171:web:06cb9a9057bac2952bf1ee"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const chatRef = ref(db, "messages");
const usersRef = ref(db, "users");
const typingRef = ref(db, "typing");

let username = null, role = null;

const loginBox = document.getElementById("loginBox");
const messagesDiv = document.getElementById("messages");
const inputArea = document.getElementById("inputArea");
const input = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");
const fileBtn = document.getElementById("fileBtn");
const fileInput = document.getElementById("fileInput");
const participantsBtn = document.getElementById("participantsBtn");
const participantsPanel = document.getElementById("participantsPanel");
const participantsList = document.getElementById("participantsList");
const emojiBtn = document.getElementById("emojiBtn");
const emojiPanel = document.getElementById("emojiPanel");
const notifyAll = document.getElementById("notifyAll");
const notifyTeachers = document.getElementById("notifyTeachers");
const downloadChat = document.getElementById("downloadChat");

const autoRoles = {
  "Ù‡Ø§Ø¯ÙŠ Ù…Ø­Ù…Ø¯ Ù…Ø­Ø³Ù† Ø¬Ù„Ø§Ù„": "Ù…Ø¯ÙŠØ±",
  "Ù…Ø­Ù…Ø¯ Ø³Ø§Ù„Ù… Ø¹Ù„ÙŠ Ø¬Ù„Ø§Ù„": "ÙˆÙƒÙŠÙ„"
};

/* ===== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ Ø¥Ù„Ø²Ø§Ù…ÙŠ + Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±) ===== */
document.getElementById("loginBtn").addEventListener("click", async () => {
  const nameInput = document.getElementById("usernameInput").value.trim();
  if (nameInput.split(" ").length < 3) { alert("âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ"); return; }
  try {
    const snap = await get(usersRef);
    if (snap.exists() && snap.hasChild(nameInput)) { alert("âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹"); return; }
  } catch (e) { console.warn("ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø³Ù…Ø§Ø¡:", e); }
  username = nameInput;
  role = autoRoles[username] || document.getElementById("roleInput").value;
  localStorage.setItem("username", username);
  localStorage.setItem("role", role);
  loginBox.style.display = "none"; messagesDiv.style.display = "flex"; inputArea.style.display = "flex";
  joinChat();
});

/* Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯ */
if (localStorage.getItem("username")) {
  username = localStorage.getItem("username");
  role = localStorage.getItem("role");
  loginBox.style.display = "none"; messagesDiv.style.display = "flex"; inputArea.style.display = "flex";
  joinChat();
}

function joinChat() {
  set(ref(db, "users/" + username), { role: role, online: true });
  // Ù†Ø¸Ù Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬ / Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
  window.addEventListener("beforeunload", () => {
    if (username) set(ref(db, "users/" + username + "/online"), false);
    if (username) update(ref(db, "typing/" + username), { typing: false });
  });
}

/* ===== Helpers: Avatars ===== */
function getAvatar(u, r) {
  const defaultAvatars = { "Ù…Ø¯ÙŠØ±": "ğŸŸ¢", "ÙˆÙƒÙŠÙ„": "ğŸ”µ", "Ù…Ø¹Ù„Ù…": "ğŸŸ¡", "Ø·Ø§Ù„Ø¨": "âšª", "ÙˆÙ„ÙŠ Ø£Ù…Ø±": "ğŸŸ " };
  return defaultAvatars[r] || "âšª";
}

/* ===== Ø¥Ø±Ø³Ø§Ù„ Ù†Øµ / Ù…Ù„Ù ===== */
sendBtn.addEventListener("click", () => sendMessage(input.value));
function sendMessage(text) {
  if (!text || !text.trim()) return;
  push(chatRef, { user: username, role: role, text: text, type: "text", time: new Date().toLocaleTimeString() });
  input.value = "";
  notifyUser("Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©", text);
}

fileBtn.addEventListener("click", () => fileInput.click());
fileInput.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (file) {
    push(chatRef, { user: username, role: role, text: "ğŸ“ Ù…Ù„Ù/ØµÙˆØ±Ø©: " + file.name, type: "file", time: new Date().toLocaleTimeString() });
    notifyUser("Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯", file.name);
  }
});

/* ===== Emojis ===== */
emojiBtn.addEventListener("click", () => {
  emojiPanel.style.display = emojiPanel.style.display === "none" ? "block" : "none";
});
emojiPanel.addEventListener("click", (e) => {
  if (e.target.tagName === "SPAN") {
    input.value += e.target.textContent;
    emojiPanel.style.display = "none";
    input.focus();
  }
});

/* ===== Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ø§Ù„Ù…Ø±Ø³Ù„Ø© ÙŠØ³Ø§Ø±ØŒ Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø© ÙŠÙ…ÙŠÙ†) Ù…Ø¹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø°Ù ===== */
onChildAdded(chatRef, snapshot => {
  const msg = snapshot.val();
  const key = snapshot.key;
  const div = document.createElement("div");
  div.className = "message " + (msg.user === username ? "sent" : "received");
  div.dataset.key = key;

  if (msg.deleted) {
    div.innerHTML = `<div class="deletedMsg">ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨ÙˆØ§Ø³Ø·Ø© ${msg.deletedBy || "Ø§Ù„Ù…Ø±Ø³Ù„"}</div>`;
  } else {
    const meta = document.createElement("div");
    meta.className = "meta";
    meta.style.textAlign = msg.user === username ? "left" : "right";
    meta.textContent = `${getAvatar(msg.user, msg.role)} ${msg.user} (${msg.role}) â€¢ ${msg.time || ""}`;
    div.appendChild(meta);

    const content = document.createElement("div");
    content.style.textAlign = msg.user === username ? "left" : "right";
    content.textContent = msg.text;
    div.appendChild(content);
  }

  // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ø·ÙˆÙŠÙ„ / ÙƒÙ„ÙŠÙƒ ÙŠÙ…ÙŠÙ†
  div.addEventListener("contextmenu", (e) => { e.preventDefault(); showActionMenu(e.clientX, e.clientY, msg, key, div); });

  // Ù„Ù…Ø³ Ø·ÙˆÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„
  let touchTimer = null;
  div.addEventListener("touchstart", (e) => {
    if (touchTimer) clearTimeout(touchTimer);
    touchTimer = setTimeout(() => {
      const touch = e.touches[0];
      showActionMenu(touch.clientX, touch.clientY, msg, key, div);
    }, 600);
  });
  div.addEventListener("touchend", (e) => { if (touchTimer) clearTimeout(touchTimer); });

  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

/* ===== Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª (Ø­Ø°Ù Ù„Ø¯Ù‰ Ø§Ù„Ø¬Ù…ÙŠØ¹ Ù„Ù„Ù…Ø®ÙˆÙ„ÙŠÙ† Ø£Ùˆ Ø­Ø°Ù Ù„Ø¯Ù‰ Ø§Ù„Ù…Ø±Ø³Ù„) ===== */
function showActionMenu(x, y, msg, key, anchorDiv) {
  const prev = document.querySelector(".actionMenu"); if (prev) prev.remove();
  const menu = document.createElement("div"); menu.className = "actionMenu";
  // Ø¶Ø¨Ø· Ù…ÙƒØ§Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø§Ø´Ø©
  const menuWidth = 160;
  const menuHeightEstimate = 120;
  const winW = window.innerWidth, winH = window.innerHeight;
  let left = x, top = y;
  if (left + menuWidth > winW) left = winW - menuWidth - 10;
  if (top + menuHeightEstimate > winH) top = winH - menuHeightEstimate - 10;
  menu.style.left = left + "px"; menu.style.top = top + "px";

  // Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø­Ø°Ù Ù„Ø¯Ù‰ Ø§Ù„Ù…Ø±Ø³Ù„ (Ø¥Ù† ÙƒØ§Ù†Øª Ø±Ø³Ø§Ù„ØªÙƒ)
  if (msg.user === username) {
    const delSelf = document.createElement("button"); delSelf.textContent = "ğŸ—‘ï¸ Ø­Ø°Ù Ù„Ø¯Ù‰ Ø§Ù„Ù…Ø±Ø³Ù„";
    delSelf.addEventListener("click", () => { update(ref(db, "messages/" + key), { deleted: true, deletedBy: "Ø§Ù„Ù…Ø±Ø³Ù„" }); menu.remove(); });
    menu.appendChild(delSelf);
  }
  // Ø­Ø°Ù Ù„Ø¯Ù‰ Ø§Ù„Ø¬Ù…ÙŠØ¹ (Ù„Ù„Ù…Ø¯ÙŠØ±/ÙˆÙƒÙŠÙ„/Ù…Ø¹Ù„Ù…)
  if (["Ù…Ø¯ÙŠØ±", "ÙˆÙƒÙŠÙ„", "Ù…Ø¹Ù„Ù…"].includes(role)) {
    const delAll = document.createElement("button"); delAll.textContent = "ğŸ›‘ Ø­Ø°Ù Ù„Ø¯Ù‰ Ø§Ù„Ø¬Ù…ÙŠØ¹";
    delAll.addEventListener("click", () => {
      if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ø¯Ù‰ Ø§Ù„Ø¬Ù…ÙŠØ¹ØŸ")) {
        update(ref(db, "messages/" + key), { deleted: true, deletedBy: role });
      }
      menu.remove();
    });
    menu.appendChild(delAll);
  }

  const closeBtn = document.createElement("button"); closeBtn.textContent = "Ø¥ØºÙ„Ø§Ù‚";
  closeBtn.addEventListener("click", () => menu.remove());
  menu.appendChild(closeBtn);

  document.body.appendChild(menu);
  setTimeout(() => {
    const remover = (ev) => { if (!menu.contains(ev.target)) menu.remove(); document.removeEventListener("click", remover); };
    document.addEventListener("click", remover);
  }, 50);
}

/* ===== Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ† (Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ø¹Ù† ØºÙŠØ± Ø§Ù„Ù…Ø®ÙˆÙ„ÙŠÙ†) ===== */
participantsBtn.addEventListener("click", () => { participantsPanel.style.display = "block"; updateParticipantsList(); });
function updateParticipantsList() {
  onValue(usersRef, snapshot => {
    participantsList.innerHTML = "";
    snapshot.forEach(snap => {
      const u = snap.key; const data = snap.val();
      if (["Ø·Ø§Ù„Ø¨", "ÙˆÙ„ÙŠ Ø£Ù…Ø±"].includes(data.role) && !["Ù…Ø¯ÙŠØ±", "ÙˆÙƒÙŠÙ„", "Ù…Ø¹Ù„Ù…"].includes(role)) return;
      const li = document.createElement("li");
      li.textContent = `${u} (${data.role}) - ${data.online ? "ğŸŸ¢ Ù…ØªØµÙ„" : "âšª ØºÙŠØ± Ù…ØªØµÙ„"}`;
      participantsList.appendChild(li);
    });
  });
}

/* ===== Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØµÙÙŠØ© ===== */
function notifyUser(title, body) {
  if (!notifyAll.checked) return;
  // Ø¥Ø°Ø§ Ø§Ø®ØªØ§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ù† ÙŠØ³ØªÙ‚Ø¨Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† ÙÙ‚Ø·
  if (notifyTeachers.checked && !["Ù…Ø¯ÙŠØ±", "ÙˆÙƒÙŠÙ„", "Ù…Ø¹Ù„Ù…"].includes(role)) return;
  if (Notification.permission === "granted") {
    new Notification(title, { body });
  } else if (Notification.permission !== "denied") {
    Notification.requestPermission().then(() => { /* Ù„Ø§ Ø´ÙŠØ¡ Ø¥Ø¶Ø§ÙÙŠ */ });
  }
}

/* ===== Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø© Typing Indicator ===== */
let typingTimeout = null;
input.addEventListener("input", () => {
  if (!username) return;
  set(ref(db, "typing/" + username), { role: role, typing: input.value.length > 0 });
  if (typingTimeout) clearTimeout(typingTimeout);
  typingTimeout = setTimeout(() => {
    update(ref(db, "typing/" + username), { typing: false });
  }, 1200);
});
onValue(typingRef, snap => {
  // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø±Ø§Øª Ø³Ø§Ø¨Ù‚Ø©
  messagesDiv.querySelectorAll(".typingIndicator").forEach(e => e.remove());
  let typingText = "";
  snap.forEach(s => {
    const u = s.key; const data = s.val();
    if (data && data.typing && u !== username) typingText += `${u} ÙŠÙƒØªØ¨... `;
  });
  if (typingText) {
    const tdiv = document.createElement("div"); tdiv.className = "typingIndicator"; tdiv.textContent = typingText;
    messagesDiv.appendChild(tdiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }
});

/* ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ===== */
downloadChat.addEventListener("click", async () => {
  const snap = await get(chatRef);
  if (!snap.exists()) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ù„ØªØ­Ù…ÙŠÙ„Ù‡Ø§.");
  let text = "";
  snap.forEach(s => {
    const m = s.val();
    text += `${m.time || ""} ${m.user || ""} (${m.role || ""}): ${m.text || ""}\n`;
  });
  const blob = new Blob([text], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download = "chat.txt"; a.click();
  URL.revokeObjectURL(url);
});

/* ===== Pinch-to-Zoom Ø¹Ù„Ù‰ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (#messages) =====
   ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù„Ù…Ø³: Ø¥ØµØ¨Ø¹ÙŠÙ† Ù„ØªÙƒØ¨ÙŠØ±/ØªØµØºÙŠØ±. === */
let initialDistance = null;
let baseScale = 1;
let pinchCenter = { x: 0, y: 0 };

function getDistance(touches) {
  const dx = touches[0].clientX - touches[1].clientX;
  const dy = touches[0].clientY - touches[1].clientY;
  return Math.hypot(dx, dy);
}
function getCenter(touches) {
  return {
    x: (touches[0].clientX + touches[1].clientX) / 2,
    y: (touches[0].clientY + touches[1].clientY) / 2
  };
}

messagesDiv.addEventListener("touchstart", (e) => {
  if (e.touches.length === 2) {
    initialDistance = getDistance(e.touches);
    pinchCenter = getCenter(e.touches);
    // Ù„Ù…Ù†Ø¹ Ø³Ø­Ø¨ Ø§Ù„ØµÙØ­Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù€ pinch
    e.preventDefault();
  }
}, { passive: false });

messagesDiv.addEventListener("touchmove", (e) => {
  if (e.touches.length === 2 && initialDistance) {
    const newDist = getDistance(e.touches);
    const scale = Math.max(0.6, Math.min(2.5, baseScale * (newDist / initialDistance)));
    // Ø¶Ø¨Ø· Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒØ¨ÙŠØ± ÙƒØªØ­ÙˆÙŠÙ„ Ø¨Ø³ÙŠØ· Ø¹Ù† Ø·Ø±ÙŠÙ‚ transform-origin
    const rect = messagesDiv.getBoundingClientRect();
    const originX = ((pinchCenter.x - rect.left) / rect.width) * 100;
    const originY = ((pinchCenter.y - rect.top) / rect.height) * 100;
    messagesDiv.style.transformOrigin = `${originX}% ${originY}%`;
    messagesDiv.style.transform = `scale(${scale})`;
    e.preventDefault();
  }
}, { passive: false });

messagesDiv.addEventListener("touchend", (e) => {
  if (initialDistance) {
    // Ø®Ø²Ù‘Ù† Ø§Ù„Ù…Ù‚ÙŠØ§Ø³ Ø§Ù„Ø­Ø§Ù„ÙŠ
    const transform = messagesDiv.style.transform || "";
    const m = transform.match(/scale\(([^)]+)\)/);
    if (m) baseScale = parseFloat(m[1]);
    // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø©
    initialDistance = null;
    pinchCenter = { x: 0, y: 0 };
    // Ø¥Ø°Ø§ ØµØ§Ø± Ø§Ù„Ù…Ù‚ÙŠØ§Ø³ Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ù…Ù† 1 Ù†Ø¹ÙŠØ¯ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„ØªØ¬Ù†Ø¨ ØªØ±Ø§ÙƒÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª
    if (Math.abs(baseScale - 1) < 0.02) {
      baseScale = 1; messagesDiv.style.transform = ""; messagesDiv.style.transformOrigin = "center top";
    }
  }
});

/* ===== Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø© =====
   - Ø£Ø«Ù†Ø§Ø¡ Pinch ÙŠØªÙ… Ù…Ù†Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù…Ù†Ø¹ ØªØ¹Ø§Ø±Ø¶ Ø§Ù„Ù„Ù…Ø³ ÙˆØ§Ù„ØªÙ…Ø±ÙŠØ±.
   - Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ù€ scale = 0.6 ÙˆØ§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ = 2.5 (ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡). */

/* ===== ØªÙ†Ø¸ÙŠÙ Ø¨Ø³ÙŠØ· Ø¹Ù†Ø¯ ØªØ±Ùƒ Ø§Ù„ØµÙØ­Ø© ===== */
window.addEventListener("unload", () => {
  if (username) update(ref(db, "typing/" + username), { typing: false });
});

/* === Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø³ÙƒØ±Ø¨Øª === */
</script>
</body>
</html>
